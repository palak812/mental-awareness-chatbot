<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Health Chatbot</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.3/dist/tailwind.min.css">

    <style>
        body {
            background: linear-gradient(to right, #a18cd1, #fbc2eb);
            font-family: 'Poppins', sans-serif;
        }

        .login-box, .chat-window {
            max-width: 600px;
            margin: 80px auto;
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .button, .send-button {
            background: linear-gradient(to right, #a18cd1, #fbc2eb);
            color: white;
            font-weight: bold;
            transition: 0.3s;
        }

        .button:hover, .send-button:hover {
            background: linear-gradient(to right, #8d74c4, #e7b3db);
        }

        .bot-message, .user-message {
            border-radius: 18px;
            padding: 10px;
            margin: 10px 0;
            max-width: 75%;
        }

        .bot-message {
            background-color: #c3aed6;
        }

        .user-message {
            background-color: #a3d8f4;
            margin-left: auto;
        }

        .mic-button {
            background: #fff;
            border: 2px solid #a18cd1;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-top-color: #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .history-box {
            background: #fff;
            padding: 10px;
            border-radius: 10px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
    </style>
</head>

<body>

<!-- LOGIN SECTION -->
<div id="loginPage" class="login-box">
    <h2 class="text-2xl font-bold text-center mb-5">Login</h2>

    <label>Username</label>
    <input type="text" id="username" class="w-full border p-2 rounded mb-4">

    <label>Password</label>
    <input type="password" id="password" class="w-full border p-2 rounded mb-4">

    <button class="button w-full py-2 rounded" onclick="login()">Login</button>

    <p class="text-center mt-3 text-sm text-gray-600">*Use any username and password.</p>
</div>


<!-- CHATBOT SECTION -->
<div id="chatPage" class="chat-window" style="display:none;">
    <h2 class="text-xl font-bold mb-4">Welcome, <span id="userDisplay"></span> ðŸ‘‹</h2>

    <h3 class="font-semibold mb-2">Chat History</h3>
    <div id="history" class="history-box text-sm mb-4"></div>

    <hr class="my-4">

    <div id="chat-content">
        <div class="bot-message">
            Hello! I'm here to support you. How can I help today?
        </div>
    </div>

    <div class="flex items-center mt-4">
        <input type="text" id="user-input" class="flex-grow border p-2 rounded" placeholder="Type a message...">

        <button class="mic-button ml-2" onclick="startVoice()">ðŸŽ¤</button>

        <button class="send-button ml-2 px-4 py-2 rounded" onclick="sendMessage()">Send</button>
    </div>
</div>


<script>

    let currentUser = "";

    /* ------------------------------------
       LOGIN FUNCTION
    ------------------------------------ */
    function login() {
        let user = document.getElementById("username").value.trim();
        let pass = document.getElementById("password").value.trim();

        if (user === "" || pass === "") {
            alert("Please fill in both fields");
            return;
        }

        currentUser = user;

        localStorage.setItem("loggedUser", user);

        document.getElementById("loginPage").style.display = "none";
        document.getElementById("chatPage").style.display = "block";

        document.getElementById("userDisplay").innerText = user;

        loadHistory();
    }

    /* ------------------------------------
       LOAD USER-SPECIFIC HISTORY
    ------------------------------------ */
    function loadHistory() {
        let key = "chatHistory_" + currentUser;

        let history = JSON.parse(localStorage.getItem(key)) || [];

        let box = document.getElementById("history");
        box.innerHTML = "";

        history.forEach(item => {
            box.innerHTML += `<p>â€¢ ${item}</p>`;
        });
    }

    /* ------------------------------------
       SAVE HISTORY PER USER
    ------------------------------------ */
    function saveHistory(text) {
        let key = "chatHistory_" + currentUser;

        let history = JSON.parse(localStorage.getItem(key)) || [];
        history.push(text);

        localStorage.setItem(key, JSON.stringify(history));

        loadHistory();
    }

    /* ------------------------------------
       SEND MESSAGE
    ------------------------------------ */
    async function displayResponse(prompt) {
        const chatContent = document.getElementById("chat-content");

        chatContent.innerHTML += `<div class="user-message">${prompt}</div>`;
        
        saveHistory(prompt);

        chatContent.innerHTML += `<div class="spinner"></div>`;

        try {
            const response = await fetch("https://backend.buildpicoapps.com/aero/run/llm-api?pk=v1-Z0FBQUFBQm93bExvVlJyQjFUR3pscEsxVTZDdk1QOE9rTFF3SU9iczJIR3N0VHJjSFVpU20xVzZoS29RbGJGRGY1dkFwOF9SOEdZOFJMZ3pyMThMWUFQYlA3SHItcndwVVE9PQ==", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt })
            });

            const result = await response.json();

            chatContent.innerHTML = chatContent.innerHTML.replace(`<div class="spinner"></div>`, "");

            if (result.status === "success") {
                chatContent.innerHTML += `<div class="bot-message">${result.text}</div>`;
            } else {
                chatContent.innerHTML += `<div class="bot-message">Something went wrong.</div>`;
            }

        } catch (error) {
            chatContent.innerHTML += `<div class="bot-message">Connection error. Try again.</div>`;
        }
    }

    function sendMessage() {
        const input = document.getElementById("user-input");
        let text = input.value.trim();

        if (text !== "") {
            input.value = "";
            displayResponse(text);
        }
    }

    /* ------------------------------------
       ðŸŽ¤ VOICE INPUT
    ------------------------------------ */
    function startVoice() {
        if (!("webkitSpeechRecognition" in window)) {
            alert("Your browser doesn't support voice input");
            return;
        }

        const recog = new webkitSpeechRecognition();
        recog.lang = "en-US";
        recog.start();

        recog.onresult = function(event) {
            const text = event.results[0][0].transcript;
            document.getElementById("user-input").value = text;
        };
    }

</script>

</body>
</html>
